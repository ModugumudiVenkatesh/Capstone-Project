<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="posts.css">
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="m-0">Posts</h2>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" (click)="openProfileModal()">My Profile</button>
                <a class="btn btn-outline-secondary" href="/admin/posts">Back to Post Approvals</a>
                <a class="btn btn-outline-secondary" href="/admin/reports">Admin Reports</a>
                <button class="btn btn-danger" (click)="logout()">Logout</button>
            </div>
        </div>

        <div class="card p-3 mb-4">
            <div class="input-group">
                <input [(ngModel)]="userSearch" (keyup.enter)="searchUsers()" class="form-control"
                    placeholder="Search users by name, username, email, or phone..." />
                <button class="btn btn-outline-secondary" (click)="searchUsers()">Search</button>
            </div>

            <div *ngIf="isSearching" class="mt-2 small text-muted">Searching‚Ä¶</div>

            <div *ngIf="!isSearching && userResults.length" class="mt-3">
                <div *ngFor="let u of userResults" class="user-card">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="user-info">
                            <h4>{{ u.username || u.userName || u.name }}</h4>
                            <p>{{ u.email || 'No email' }} ¬∑ {{ u.fullName || 'No name' }}</p>
                        </div>

                        <div class="user-actions">
                            <button class="btn btn-sm btn-primary" (click)="viewUserProfile(u)">
                                <i class="fas fa-user"></i> View Profile
                            </button>
                            <button class="btn btn-sm btn-secondary" (click)="openMessageModal(u)">
                                <i class="fas fa-envelope"></i> Message
                            </button>
                            <button class="btn btn-sm btn-danger" (click)="toggleReport(u)">
                                {{ u._reportOpen ? 'Cancel' : 'Report' }}
                            </button>
                        </div>
                    </div>

                    <div *ngIf="u._reportOpen" class="mt-2">
                        <div class="input-group">
                            <input [(ngModel)]="u._reason" class="form-control"
                                placeholder="Reason (spam, abuse, fake profile, etc.)" />
                            <button class="btn btn-danger" [disabled]="reportingBusyId === (u.userId || u.UserId || u.id)"
                                (click)="submitReport(u)">
                                Submit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div *ngIf="!isSearching && userResults && !userResults.length && userSearch" class="mt-2 small text-muted">
                No users found.
            </div>
        </div>

        <div class="card p-3 mb-4">
            <textarea [(ngModel)]="content" class="form-control" placeholder="What's on your mind?"></textarea>
            <input type="file" (change)="onFileSelected($event)" class="form-control mt-2" />
            <button (click)="createPost()" class="btn btn-primary mt-2">Post</button>
        </div>

        <div *ngFor="let post of posts" class="card mb-3">
            <div class="card-body">
                <p class="mb-2">{{ post.content }}</p>

                <img *ngIf="post.postImage" [src]="'http://localhost:5293/' + normalizePath(post.postImage)"
                    class="img-fluid mb-2" />

                <div class="d-flex align-items-center gap-2">
                    <button (click)="toggleLike(post)" class="btn btn-sm" [ngClass]="post._liked ? 'btn-danger' : 'btn-primary'">
                        {{ post._liked ? 'Unlike' : 'Like' }}
                    </button>

                    <span class="text-muted small me-3">üëç {{ post.likeCount || 0 }}</span>

                    <button class="btn btn-sm btn-outline-danger" (click)="toggleReportOnPost(post)">
                        {{ post._reportOpen ? 'Cancel Report' : 'Report User' }}
                    </button>
                </div>

                <div *ngIf="post._reportOpen" class="mt-2">
                    <div class="input-group">
                        <input [(ngModel)]="post._reason" class="form-control" placeholder="Reason (spam, abuse, fake, etc.)" />
                        <button class="btn btn-danger" (click)="submitReportForPost(post)">Submit</button>
                    </div>
                </div>

                <div class="mt-3 border-top pt-3">
                    <h6 class="mb-2">Comments</h6>

                    <div *ngIf="post.comments?.length; else noComments">
                        <div *ngFor="let c of post.comments" class="mb-2">
                            <strong>{{ c.userName || 'User' }}</strong>:
                            <span>{{ c.text }}</span>
                        </div>
                    </div>
                    <ng-template #noComments>
                        <p class="text-muted mb-2">No comments yet.</p>
                    </ng-template>

                    <div class="input-group mt-2">
                        <input [(ngModel)]="post.newComment" placeholder="Add a comment" class="form-control" />
                        <button class="btn btn-outline-primary" (click)="commentPost(post)">
                            Comment
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Profile Modal -->
        <div *ngIf="showUserProfileModal" class="modal-backdrop-custom">
            <div class="modal-custom">
                <div class="modal-header-custom">
                    <h3>User Profile</h3>
                    <button class="close-btn" (click)="closeUserProfileModal()">&times;</button>
                </div>
                <div class="modal-body-custom" *ngIf="selectedUser">
                    <div class="profile-header">
                        <div class="profile-image">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="profile-info">
                            <h2>{{ selectedUser.fullName || selectedUser.username }}</h2>
                            <p>{{ selectedUser.email }}</p>
                        </div>
                    </div>
                    <div class="profile-details">
                        <div class="detail-item">
                            <label>Username:</label>
                            <span>{{ selectedUser.username || selectedUser.userName || 'Not provided' }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Email:</label>
                            <span>{{ selectedUser.email || 'Not provided' }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Phone:</label>
                            <span>{{ selectedUser.phone || 'Not provided' }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Member since:</label>
                            <span>{{ selectedUser.createdAt | date:'mediumDate' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Modal -->
        <div *ngIf="showMessageModal" class="modal-backdrop-custom">
            <div class="modal-custom message-modal">
                <div class="modal-header-custom">
                    <h3>Message {{ selectedUser?.fullName || selectedUser?.username }}</h3>
                    <button class="close-btn" (click)="closeMessageModal()">&times;</button>
                </div>
                <div class="modal-body-custom">
                    <div class="message-history">
                        <div *ngFor="let msg of messageHistory" [class]="'message ' + (msg.senderId === selectedUser.id ? 'received' : 'sent')">
                            <p>{{ msg.content }}</p>
                            <span class="time">{{ msg.timestamp | date:'short' }}</span>
                        </div>
                    </div>
                    <div class="message-input">
                        <textarea [(ngModel)]="messageText" placeholder="Type your message..." (keydown.enter)="sendMessage()"></textarea>
                        <button (click)="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Modal (existing) -->
        <div class="modal-backdrop fade show" *ngIf="showProfileModal" style="display:block; background: rgba(0,0,0,.35);">
        </div>

        <div class="modal fade show" tabindex="-1" role="dialog" *ngIf="showProfileModal" style="display:block;">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">{{ profile ? 'Edit Profile' : 'Create Profile' }}</h5>
                        <button type="button" class="btn-close" aria-label="Close" (click)="closeProfileModal()"></button>
                    </div>

                    <div class="modal-body">
                        <div class="d-flex align-items-center gap-3 mb-3">
                            <img *ngIf="profile?.profileImage" [src]="'http://localhost:5293/' + normalizePath(profile.profileImage)"
                                class="rounded" style="width:64px;height:64px;object-fit:cover" />
                            <div class="small text-muted" *ngIf="!profile?.profileImage">
                                No profile image yet.
                            </div>
                        </div>

                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label">Full name *</label>
                                <input [(ngModel)]="profileForm.fullName" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input [(ngModel)]="profileForm.email" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input [(ngModel)]="profileForm.phone" class="form-control" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Bio</label>
                                <textarea [(ngModel)]="profileForm.bio" rows="2" class="form-control"></textarea>
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">Profile image</label>
                            <div class="input-group">
                                <input type="file" class="form-control" (change)="onProfileImageSelected($event)" />
                                <button class="btn btn-outline-primary" [disabled]="!profileImageFile || uploadingProfileImage"
                                    (click)="uploadProfilePic(true)">
                                    {{ uploadingProfileImage ? 'Uploading‚Ä¶' : 'Upload Image' }}
                                </button>
                            </div>
                            <div class="form-text">You can save details first, then upload an image; or upload now.</div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-secondary" (click)="closeProfileModal()">Close</button>
                        <button class="btn btn-success" [disabled]="savingProfile" (click)="saveProfile()">
                            {{ savingProfile ? 'Saving‚Ä¶' : (profile ? 'Save Changes' : 'Create Profile') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>